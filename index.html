<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="style.css">
  <meta charset="UTF-8">
  <title>Steam Page Check</title>
</head>
<body>

  <div class="container">

    <div class="header">
      <h1>Steam Page Check</h1>
      <div class="accent"></div>
      <p>Preflight your Steam store page against common review expectations before submission. Advisory only — not affiliated with Valve.</p>
    </div>

    <label>Steam Store URL (public page)</label>
    <input id="steamUrl" type="text" placeholder="https://store.steampowered.com/app/123456">

    <label>Or paste your store page text</label>
    <textarea id="steamText" placeholder="Paste About This Game, Early Access notes, pricing info, etc."></textarea>

    <div class="buttons">
      <button onclick="runCheck()">Run Check</button>
      <button class="secondary" onclick="copyResults()">Copy Results</button>
      <button class="ghost" onclick="loadSample()">Load Test Example</button>
      <button class="ghost" onclick="toggleDarkMode()">Toggle Light/Dark</button>
      <button class="secondary" id="unlockBtn">Unlock All Checks</button>
    </div>

    <div class="summary-bar" id="summaryBar"></div>

    <h2>Results</h2>
    <div id="output">No checks run yet.</div>

    <h2>Check Access</h2>
    <div id="results-container"></div>

    <footer>steampagecheck.com · Not affiliated with Valve or Steam</footer>
  </div>

  <!-- Paddle Sandbox JS - MUST LOAD FIRST -->
  <script src="https://cdn.paddle.com/paddle/paddle.js"></script>

  <!-- Inline Paddle Initialization -->
  <script>
    const PADDLE_CLIENT_TOKEN = 'test_c2deb3cb9b85f4b2afcd596c107';
    const PADDLE_PRICE_ID = 'pri_01kfc8wsrhhqezk6htxdy7eppe';

    // Track unlock state
    let hasPaid = localStorage.getItem('unlocked') === 'true';

    function setUnlocked(state) {
      hasPaid = state;
      if (state) localStorage.setItem('unlocked', 'true');
      else localStorage.removeItem('unlocked');
    }

    function initPaddle() {
      if (typeof Paddle === 'undefined') {
        console.error('Paddle SDK not loaded');
        return;
      }

      try {
        // ✅ Step 1: Set environment BEFORE initialization
        Paddle.Environment.set('sandbox');
        console.log('Paddle environment set to sandbox');

        // ✅ Step 2: Initialize Paddle
        Paddle.Initialize({
          token: PADDLE_CLIENT_TOKEN,
          eventCallback: function(data) {
            console.log('PADDLE EVENT:', data.name, data);

            if (data.name === 'checkout.completed') {
              console.log('Payment completed! Unlocking...');
              setUnlocked(true);

              setTimeout(() => {
                Paddle.Checkout.close();
                if (typeof renderChecks === 'function') renderChecks();
              }, 1000);
            }
          }
        });
        console.log('Paddle initialized successfully');

        // ✅ Step 3: Attach unlock button AFTER initialization
        const unlockBtn = document.getElementById('unlockBtn');
        unlockBtn.addEventListener('click', () => {
          Paddle.Checkout.open({
            items: [{ priceId: PADDLE_PRICE_ID, quantity: 1 }]
          });
        });

      } catch (err) {
        console.error('Paddle initialization failed:', err);
      }
    }

    // Run initialization on DOM ready
    document.addEventListener('DOMContentLoaded', initPaddle);
  </script>

  <!-- Your app JS -->
  <script src="main.js"></script>
</body>
</html>
