<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Steam Page Check</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

  <div class="container">

    <div class="header">
      <h1>Steam Page Check</h1>
      <div class="accent"></div>
      <p>Preflight your Steam store page against common review expectations before submission. Advisory only â€” not affiliated with Valve.</p>
    </div>

    <label for="steamUrl">Steam Store URL (public page)</label>
    <input id="steamUrl" type="text" placeholder="https://store.steampowered.com/app/123456">

    <label for="steamText">Or paste your store page text</label>
    <textarea id="steamText" placeholder="Paste About This Game, Early Access notes, pricing info, etc."></textarea>

    <div class="buttons">
      <button id="runCheckBtn">Run Check</button>
      <button class="secondary" id="copyResultsBtn">Copy Results</button>
      <button class="ghost" id="loadSampleBtn">Load Test Example</button>
      <button class="ghost" id="toggleThemeBtn">Toggle Light/Dark</button>
      <button class="secondary" id="unlockBtn">ðŸ”“ Unlock All Checks</button>
    </div>

    <div class="summary-bar" id="summaryBar"></div>

    <h2>Results</h2>
    <div id="output">No checks run yet.</div>

    <div class="unlock-banner" id="unlockBanner">
      <span class="unlock-icon">ðŸ”’</span>
      <div class="unlock-text">
        <strong>Premium checks are locked</strong>
        <span>Unlock all 8 checks for a one-time payment</span>
      </div>
      <button id="unlockBannerBtn">Unlock Now</button>
    </div>

    <footer>
      <p>Steam Page Check â€” Built for indie developers. Not affiliated with Valve Corporation.</p>
    </footer>

  </div>

  <!-- Paddle Billing SDK (v2) -->
  <script src="https://cdn.paddle.com/paddle/v2/paddle.js"></script>

  <script>
    // ================================================
    // PADDLE BILLING CONFIGURATION (Sandbox)
    // ================================================
    const PADDLE_CLIENT_TOKEN = 'test_86bf96ddbab105199d721ee81ae';
    const PADDLE_PRICE_ID = 'pri_01kft4eh4rcjcx5pq2tvhwsw27';

    console.log('[SteamCheck] Config loaded:', { 
      token: PADDLE_CLIENT_TOKEN.substring(0, 10) + '...', 
      priceId: PADDLE_PRICE_ID 
    });

    // ================================================
    // UNLOCK STATE MANAGEMENT
    // ================================================
    function isUnlocked() {
      const state = localStorage.getItem('steamcheck_unlocked') === 'true';
      console.log('[SteamCheck] isUnlocked() =', state);
      return state;
    }

    function setUnlocked(state) {
      console.log('[SteamCheck] setUnlocked() called with:', state);
      
      if (state) {
        localStorage.setItem('steamcheck_unlocked', 'true');
        console.log('[SteamCheck] localStorage updated: unlocked = true');
      } else {
        localStorage.removeItem('steamcheck_unlocked');
        console.log('[SteamCheck] localStorage cleared: unlocked removed');
      }
      
      updateUnlockUI();
      
      // Dispatch custom event so main.js can react
      console.log('[SteamCheck] Dispatching unlockStateChanged event');
      window.dispatchEvent(new CustomEvent('unlockStateChanged', { detail: { unlocked: state } }));
    }

    function updateUnlockUI() {
      const unlockBtn = document.getElementById('unlockBtn');
      const unlockBanner = document.getElementById('unlockBanner');
      const unlocked = isUnlocked();

      console.log('[SteamCheck] updateUnlockUI() - unlocked:', unlocked);

      if (unlockBtn) {
        unlockBtn.style.display = unlocked ? 'none' : 'inline-block';
        unlockBtn.textContent = unlocked ? 'âœ“ Unlocked' : 'ðŸ”“ Unlock All Checks';
        console.log('[SteamCheck] Unlock button visibility:', unlocked ? 'hidden' : 'visible');
      }

      if (unlockBanner) {
        unlockBanner.style.display = unlocked ? 'none' : 'flex';
        console.log('[SteamCheck] Unlock banner visibility:', unlocked ? 'hidden' : 'visible');
      }
    }

    // ================================================
    // PADDLE BILLING INITIALIZATION
    // ================================================
    function initPaddleBilling() {
      console.log('[Paddle] Checking if Paddle SDK is loaded...');
      
      if (typeof Paddle === 'undefined') {
        console.warn('[Paddle] SDK not available (expected in preview/sandbox environments)');
        showPaddleError();
        return;
      }

      console.log('[Paddle] SDK detected, initializing...');

      try {
        // Set sandbox environment BEFORE Initialize
        Paddle.Environment.set('sandbox');
        console.log('[Paddle] Environment set to: sandbox');

        // Initialize with client token and event callback
        Paddle.Initialize({
          token: PADDLE_CLIENT_TOKEN,
          eventCallback: function(event) {
            console.log('[Paddle] Event received:', event.name, event);
            
            // Handle checkout events
            switch (event.name) {
              case 'checkout.loaded':
                console.log('[Paddle] Checkout iframe loaded');
                break;
                
              case 'checkout.customer.created':
                console.log('[Paddle] Customer created:', event.data);
                break;
                
              case 'checkout.completed':
                console.log('[Paddle] âœ“ Payment successful!');
                console.log('[Paddle] Transaction data:', event.data);
                setUnlocked(true);
                showSuccessMessage();
                break;
                
              case 'checkout.closed':
                console.log('[Paddle] Checkout closed by user');
                break;
                
              case 'checkout.error':
                console.error('[Paddle] Checkout error:', event.data);
                break;
                
              default:
                console.log('[Paddle] Unhandled event:', event.name);
            }
          }
        });

        console.log('[Paddle] âœ“ Billing initialized successfully');
      } catch (error) {
        console.error('[Paddle] Initialization error:', error);
        showPaddleError();
      }
    }

    function openCheckout() {
      console.log('[Paddle] openCheckout() called');
      
      if (typeof Paddle === 'undefined' || !Paddle.Checkout) {
        console.error('[Paddle] Cannot open checkout - SDK not available');
        alert('Payment system is not available. Please refresh the page and try again.');
        return;
      }

      try {
        console.log('[Paddle] Opening checkout with priceId:', PADDLE_PRICE_ID);
        Paddle.Checkout.open({
          items: [{ priceId: PADDLE_PRICE_ID, quantity: 1 }]
        });
        console.log('[Paddle] Checkout.open() called successfully');
      } catch (error) {
        console.error('[Paddle] Checkout.open() error:', error);
        alert('Unable to open checkout. Please try again.');
      }
    }

    function showSuccessMessage() {
      console.log('[SteamCheck] Showing success message');
      const output = document.getElementById('output');
      if (output) {
        output.innerHTML = `
          <div class="result pass">
            <strong>âœ“ Premium Unlocked!</strong>
            All checks are now available. Run a check to see the full results.
          </div>
        `;
      }
    }

    function showPaddleError() {
      // In preview/sandbox environments, Paddle won't load - that's OK
      const unlockBtn = document.getElementById('unlockBtn');
      
      if (unlockBtn) {
        unlockBtn.title = 'Payment available when hosted on a live domain';
        unlockBtn.textContent = 'ðŸ”“ Unlock (requires hosting)';
      }
      
      console.log('[Paddle] Payment UI adjusted for non-hosted environment');
    }

    // ================================================
    // DOM READY - WIRE UP EVENT LISTENERS
    // ================================================
    document.addEventListener('DOMContentLoaded', () => {
      console.log('[SteamCheck] DOM ready, initializing...');
      
      // Initialize Paddle Billing
      initPaddleBilling();

      // Update UI based on current unlock state from localStorage
      console.log('[SteamCheck] Checking stored unlock state...');
      updateUnlockUI();

      // Wire up unlock button click handlers
      const unlockBtn = document.getElementById('unlockBtn');
      const unlockBannerBtn = document.getElementById('unlockBannerBtn');

      if (unlockBtn) {
        unlockBtn.addEventListener('click', () => {
          console.log('[SteamCheck] Unlock button clicked');
          openCheckout();
        });
      }

      if (unlockBannerBtn) {
        unlockBannerBtn.addEventListener('click', () => {
          console.log('[SteamCheck] Unlock banner button clicked');
          openCheckout();
        });
      }

      // Expose unlock state API globally for main.js
      window.SteamCheck = {
        isUnlocked: isUnlocked,
        setUnlocked: setUnlocked
      };
      
      console.log('[SteamCheck] âœ“ Initialization complete');
    });
  </script>

  <!-- Main app logic -->
  <script src="main.js"></script>
</body>
</html>
